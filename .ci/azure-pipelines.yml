name: $(Date:yyyyMMdd)$(Rev:.r)

pr:
  autoCancel: true

trigger:
  batch: true

jobs:
  - job: docs_build
    displayName: Docs Build
    pool:
      vmImage: windows-latest    
    steps:
    - checkout: self
      clean: true
      submodules: true
      persistCredentials: true

    - task: PowerShell@2
      displayName: "DocFX Build"
      inputs:
        targetType: 'filePath'
        filePath: '.ci/build-in-ci.ps1'
        workingDirectory: '$(Build.SourcesDirectory)'
    
    - task: CmdLine@2
      #condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
      displayName: "Clone Website"
      inputs:
        script: 'git clone https://github.com/jellyfin/jellyfin.github.io jellyfin.github.io' 
        workingDirectory: '$(Build.ArtifactStagingDirectory)'
        #failOnStderr: false # Optional

    - task: CopyFiles@2
      #condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
      displayName: "Copy Generated Website"
      inputs:
        sourceFolder: '$(Build.SourcesDirectory)/_site'
        contents: '**' 
        targetFolder: '$(Build.ArtifactStagingDirectory)/jellyfin.github.io/docs'
        cleanTargetFolder: true # Optional
        overWrite: true # Optional
        #flattenFolders: false # Optional
        #preserveTimestamp: false # Optional

    - task: CmdLine@2
      #condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
      displayName: "Add, Commit and Push files to website"
      inputs:
        script: 'git config --global core.autocrlf input && git add docs && git config --global user.email "team@jellyfin.org" && git config --global user.name "jellyfin-bot" && git commit -m "Documentation update" && git push origin'
        workingDirectory: '$(Build.ArtifactStagingDirectory)/jellyfin.github.io'
        #failOnStderr: false # Optional
